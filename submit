#!/bin/bash

set -e

# needed for stashcp to be picked up the site catalog for the local site
module load xrootd
module load stashcp

export PATH=/home/rynge/software/pegasus-4.7.0dev/bin:$PATH
#export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/home/rynge/software/pegasus-4.7.0dev/bin


TOPDIR=`pwd`

export RUN_ID=osg-gem-`date +'%s'`

export RUN_DIR=/local-scratch/$USER/workflows/$RUN_ID
mkdir -p $RUN_DIR/scratch/$RUN_ID/level-2
# make the data availabile over http
mkdir -p /stash2/user/$USER/public/$RUN_ID/data
ln -s /stash2/user/$USER/public/$RUN_ID/data $RUN_DIR/data

# generate the site catalog
SC=$RUN_DIR/sites.xml
envsubst <sites.xml.template >$SC

# generate the dax
export PYTHONPATH=`pegasus-config --python`
./tools/dax-level-1 $RUN_ID $RUN_DIR $RUN_DIR/data

echo
echo "NOTE: at the end of the workflow run, you will find the outputs in $RUN_DIR/outputs"

# plan and submit the  workflow
echo
pegasus-plan \
    -Dpegasus.catalog.site.file=$SC \
    --conf pegasus.conf \
    --relative-dir $RUN_ID \
    --sites condorpool \
    --staging-site stash \
    --output-site local \
    --dir $RUN_DIR/workflow \
    --dax dax.xml \
    --submit


