#!/usr/bin/perl

######################################################################
# Takes an merged cuffcompare .tracking file and prints out:         #
# GeneID from first element of column2 and then FPKM for all         #
# experiments.                                                       #
# Alex Feltus <ffeltus@clemson.edu>                                  #
# First Write: 10-17-2013                                            #
# Updated: 10-09-2014                                                #
#                                                                    #
######################################################################
#For each row...
#TCONS_00000004  XLOC_000004     Medtr1g004980|Medtr1g004980.1   =       q1:Medtr1g004980|Medtr1g004980.1|0|0.000000|0.000000|0.000000|0.000000|372      q2:Medtr1g004980|Medtr1g004980.1|0|0.000000|0.000000|0.000000|0.000000|372   q3:Medtr1g004980|Medtr1g004980.1|0|0.000000|0.000000|0.000000|0.000000|372      q4:Medtr1g004980|Medtr1g004980.1|0|0.000000|0.000000|0.000000|0.000000|372   q5:Medtr1g004980|Medtr1g004980.1|0|0.000000|0.000000|0.000000|0.000000|372      q6:Medtr1g004980|Medtr1g004980.1|0|0.000000|0.000000|0.000000|0.000000|372      q7:Medtr1g004980|Medtr1g004980.1|0|0.000000|0.000000|0.000000|0.000000|372   q8:Medtr1g004980|Medtr1g004980.1|100|0.119754|0.000000|0.359262|0.491484|372    q9:Medtr1g004980|Medtr1g004980.1|100|0.325725|0.000000|0.787011|0.998929|372 q10:Medtr1g004980|Medtr1g004980.1|0|0.000000|0.000000|0.000000|0.000000|372     q11:Medtr1g004980|Medtr1g004980.1|0|0.000000|0.000000|0.000000|0.000000|372     q12:Medtr1g004980|Medtr1g004980.1|0|0.000000|0.000000|0.000000|0.000000|372  q13:Medtr1g004980|Medtr1g004980.1|100|0.131857|0.000000|0.395572|0.492239|372   q14:Medtr1g004980|Medtr1g004980.1|0|0.000000|0.000000|0.000000|0.000000|372  q15:Medtr1g004980|Medtr1g004980.1|0|0.000000|0.000000|0.000000|0.000000|372     q16:Medtr1g004980|Medtr1g004980.1|0|0.000000|0.000000|0.000000|0.000000|372  q17:Medtr1g004980|Medtr1g004980.1|0|0.000000|0.000000|0.000000|0.000000|372     q18:Medtr1g004980|Medtr1g004980.1|0|0.000000|0.000000|0.000000|0.000000|372     q19:Medtr1g004980|Medtr1g004980.1|0|0.000000|0.000000|0.000000|0.000000|372  q20:Medtr1g004980|Medtr1g004980.1|100|2.113760|0.619106|3.608414|4.173120|372   q21:Medtr1g004980|Medtr1g004980.1|100|4.282762|0.452143|8.113382|2.619747|372        q22:Medtr1g004980|Medtr1g004980.1|100|2.293475|0.910457|3.676492|5.687275|372   q23:Medtr1g004980|Medtr1g004980.1|100|1.583582|0.000000|3.826229|0.503377|372q24:Medtr1g004980|Medtr1g004980.1|100|2.547306|1.071040|4.023571|6.266454|372   q25:Medtr1g004980|Medtr1g004980.1|100|2.825836|0.000000|6.088830|1.522119|372   q26:Medtr1g004980|Medtr1g004980.1|100|1.273744|0.000000|2.744538|1.511489|372        q27:Medtr1g004980|Medtr1g004980.1|0|0.000000|0.000000|0.000000|0.000000|372     q28:Medtr1g004980|Medtr1g004980.1|100|1.038731|0.190611|1.886852|2.481608|372        q29:Medtr1g004980|Medtr1g004980.1|100|1.165876|0.284556|2.047195|3.145067|372   q30:Medtr1g004980|Medtr1g004980.1|100|0.285340|0.000000|0.614822|1.365597|372q31:Medtr1g004980|Medtr1g004980.1|100|1.400182|0.466727|2.333637|4.501493|372   q32:Medtr1g004980|Medtr1g004980.1|100|1.784295|0.000000|3.569452|1.854780|372   q33:Medtr1g004980|Medtr1g004980.1|0|0.000000|0.000000|0.000000|0.000000|372  q34:Medtr1g004980|Medtr1g004980.1|0|0.000000|0.000000|0.000000|0.000000|372     q35:Medtr1g004980|Medtr1g004980.1|0|0.000000|0.000000|0.000000|0.000000|372  q36:Medtr1g004980|Medtr1g004980.1|0|0.000000|0.000000|0.000000|0.000000|372     q37:Medtr1g004980|Medtr1g004980.1|0|0.000000|0.000000|0.000000|0.000000|372     q38:Medtr1g004980|Medtr1g004980.1|100|0.082460|0.000000|0.247380|0.503102|372        q39:Medtr1g004980|Medtr1g004980.1|100|1.236091|0.000000|2.663406|1.644869|372   q40:Medtr1g004980|Medtr1g004980.1|100|7.722999|0.000000|18.660206|0.811676|372       q41:Medtr1g004980|Medtr1g004980.1|100|0.653447|0.000000|1.960340|0.553437|372   q42:Medtr1g004980|Medtr1g004980.1|100|1.443927|0.000000|2.888552|2.163529|372        q43:Medtr1g004980|Medtr1g004980.1|100|2.205076|0.000000|5.327875|0.633939|372   q44:Medtr1g004980|Medtr1g004980.1|100|0.480026|0.000000|1.440078|0.545894|372   q45:Medtr1g004980|Medtr1g004980.1|0|0.000000|0.000000|0.000000|0.000000|372  q46:Medtr1g004980|Medtr1g004980.1|100|4.311685|2.006992|6.616378|6.822060|372   q47:Medtr1g004980|Medtr1g004980.1|0|0.000000|0.000000|0.000000|0.000000|372  q48:Medtr1g004980|Medtr1g004980.1|100|4.286854|1.428951|7.144756|4.858386|372   q49:Medtr1g004980|Medtr1g004980.1|0|0.000000|0.000000|0.000000|0.000000|372  q50:Medtr1g004980|Medtr1g004980.1|0|0.000000|0.000000|0.000000|0.000000|372     q51:Medtr1g004980|Medtr1g004980.1|0|0.000000|0.000000|0.000000|0.000000|372


use warnings;
if (@ARGV < 1) {
        print "usage: ParseCuffComapreIntoFPKMMatrix <tracking_file>\n";
        die;
}

$tab_file = $ARGV[0];
@data = get_file_data ($tab_file);

#push edges into a sorted edge array with possible redundancy
foreach $line(@data) {
              chomp $line;
              @fields = ();
              @GeneName = ();
              $experiment = '';
              @fields = split (/\t/, $line);
              $rounded = '';
              @GeneName = split (/\|/, $fields[2]);
              print "$GeneName[1]\t";
              shift @fields;
              shift @fields;
              shift @fields;
              shift @fields;
              foreach $experiment (@fields) {
                 @ExperimentData = split (/\|/, $experiment);
                 $rounded = sprintf("%.3f", $ExperimentData[3]);
                 print "$rounded\t";
              }
              print"\n";
}


###########################################################################
#                             SUBROUTINES                                 #
###########################################################################

# subroutine that opens a file
sub get_file_data {

    my ($filename) = @_;
    my @filedata = ();

    unless (open (GET_FILE_DATA, $filename)){
           print STDERR "Cannot open file \"$filename\"\n\n";
           exit;
    }

    @filedata = <GET_FILE_DATA>;

    close GET_FILE_DATA;

    return @filedata;

}
